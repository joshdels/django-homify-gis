{% extends "base_v2.html" %}
{% load static %}
{% load custom_filters %}

{% block title %} Homira | Dashboard {% endblock title %}

{% block content %}

<style>
  /* Subtle card hover effect */
  .property-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative; /* required for stretched-link */
  }
  .property-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  }

  /* Sticky sidebar scroll */
  #sidebar {
    max-height: 100vh;
    overflow-y: auto;
    padding-right: 1rem; /* optional for scrollbar spacing */
  }
</style>

<div class="container-fluid p-0">
  <div class="row g-0">

    <!-- Map -->
    <div class="col-12 col-md-6 p-0" id="map" style="background-color: gray;">
      Map
    </div>

    <!-- Sidebar -->
    <div class="col-12 col-md-6 p-3 d-flex flex-column" id="sidebar">
      
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="fw-bold mb-0">My Properties</h2> 
        <a href="{% url 'listing_new' %}" class="btn btn-primary shadow-sm">
          <i class="bi bi-plus-circle me-1"></i> Add Property
        </a>
      </div>

      {% if properties %}
        <p class="fs-6 text-sm">
          You have: <strong>{{ properties|length }} unit/s</strong>
        </p>
      {% endif %}

      {% if properties %}
        <div class="row g-3">
          {% for property in properties %}
          <div class="col-12 col-md-6 col-lg-4 d-flex">
            <div class="card property-card shadow-sm h-100 border-0 w-100 d-flex flex-column">
              
              <!-- Property Image -->
              {% with first_image=property.images.first %}
                {% if first_image %}
                  <img src="{{ first_image.image.url }}" 
                       class="card-img-top img-fluid rounded-top" 
                       alt="Property image" 
                       style="height: 180px; object-fit: cover;">
                {% else %}
                  <img src="https://via.placeholder.com/400x180" 
                       class="card-img-top img-fluid rounded-top" 
                       alt="No image">
                {% endif %}
              {% endwith %}

              <!-- Body -->
              <div class="card-body flex-grow-1 position-relative">
                <h5 class="card-title text-truncate">
                  {{ property.address }}
                </h5>
                <p class="mb-2 small">
                  {{ property.get_category_display }} | {{ property.property_type|underscore_to_space|title }}
                </p>
                <p class="fw-bold mb-2">â‚± {{ property.price|floatformat:0 }}/mo</p>
                <p class="mb-0 text-muted small">
                  <i class="bi bi-calendar me-1"></i>{{ property.created_at|date:"M d, Y" }}
                </p>
                <!-- Stretched link (only covers card-body now) -->
                <a href="{% url 'listing_detail' property.id %}" class="text-decoration-none text-dark"></a>
              </div>

              <!-- Footer -->
              <div class="card-footer bg-white border-0 d-flex justify-content-between pt-2">
                <a href="{% url 'listing_update' property.id %}" class="btn btn-sm btn-outline-success">
                  <i class="bi bi-pencil-square me-1"></i> Edit
                </a>
                <button type="button" 
                        class="btn btn-sm btn-outline-danger" 
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteModal{{ property.id }}">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </div>

            <!-- Delete Modal -->
            <div class="modal fade" id="deleteModal{{ property.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content shadow-sm border-0 rounded-3">
                  <div class="modal-header border-bottom-0">
                    <h5 class="modal-title">
                      <i class="bi bi-exclamation-triangle me-2"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    Are you sure you want to delete this property?<br>
                    <strong>{{ property.description }}</strong>
                  </div>
                  <div class="modal-footer">
                    <form method="post" action="{% url 'listing_delete' property.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i> Yes, Delete
                      </button>
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Modal -->

          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-light border text-center shadow-sm rounded">
          <i class="bi bi-info-circle me-1"></i> No properties found.
        </div>
      {% endif %}

      {% include 'page_footer.html' %}
    </div>

  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'js/map/userListMap.js' %}"></script>
</div>

{% endblock %}
